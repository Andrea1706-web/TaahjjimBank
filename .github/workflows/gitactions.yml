name: Check API Before Merge

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  check-api-and-lint:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Call API to start execution
      - name: Start API Execution
        id: start_execution
        run: |
          response=$(curl -s -X POST "https://genai-code-buddy-api.stackspot.com/v1/quick-commands/create-execution/validador-pr" \
            -H "Content-Type: application/json" \
            -d '{"message":"Your message here"}')
          execution_id=$(echo $response | jq -r '.executionID')
          echo "execution_id=$execution_id" >> $GITHUB_ENV

      # Monitor API Execution Status
      - name: Monitor API Execution
        id: monitor_execution
        run: |
          status=""
          while [ "$status" != "COMPLETED" ]; do
            response=$(curl -s -X GET "https://genai-code-buddy-api.stackspot.com/v1/quick-commands/callback/{execution_id}" \
              -H "Authorization: Bearer YOUR_ACCESS_TOKEN")
            status=$(echo $response | jq -r '.progress.status')
            echo "Current status: $status"
            if [ "$status" == "FAILED" ]; then
              echo "Execution failed."
              exit 1
            fi
            sleep 3
          done
          result=$(echo $response | jq -r '.result')
          echo "Execution completed. Result: $result"

      # Run lint check
      - name: Run Lint
        run: |
          npm install
          npm run lint